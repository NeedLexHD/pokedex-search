<script>
// Charger la liste des Pokémon depuis l'API Tyradex
let pokemonList = [];

fetch("https://tyradex.app/api/v1/pokemon")
  .then(res => res.json())
  .then(data => {
    pokemonList = data.map(p => ({
      id: p.pokedex_id,
      num: String(p.pokedex_id).padStart(3, "0"),
      name: p.name.fr
    }));
  })
  .catch(err => console.error("Erreur Tyradex:", err));

// Normalisation (sans accents)
function normalize(str) {
  return str.toLowerCase().normalize("NFD").replace(/\p{Diacritic}/gu, "");
}

// Encodage pour les URLs
function encodeForURL(str) {
  return encodeURIComponent(normalize(str));
}

const input = document.getElementById("search");
const container = document.getElementById("suggestions");

input.addEventListener("input", () => {
  const q = normalize(input.value);
  container.innerHTML = "";
  if (q.length === 0) return;

  const results = pokemonList.filter(p =>
    normalize(p.name).startsWith(q) ||
    normalize(p.num).startsWith(q)
  ).slice(0, 10);

  results.forEach(p => {
    const div = document.createElement("div");
    div.className = "suggestion";
    div.textContent = `${p.num} ${p.name}`;
    div.onclick = () => openPokemon(p);
    container.appendChild(div);
  });
});

// Vérifie si une URL Google Sites existe (technique proxy Google)
function checkURLExists(url) {
  return fetch("https://www.google.com/url?q=" + encodeURIComponent(url), {
    method: "HEAD",
    mode: "no-cors"
  })
  .then(() => true)
  .catch(() => false);
}

// Génération de l'URL correcte + test 404 + redirection
function openPokemon(p) {
  const num = p.num;
  const nameSlug = encodeForURL(p.name);
  const n = p.id;

  // Tranches de 49 Pokémon
  const start = Math.floor((n - 1) / 49) * 49 + 1;
  let end = start + 48;

  if (end > 1025) end = 1025;

  const startStr = String(start).padStart(3, '0');
  const endStr = String(end).padStart(3, '0');

  const folder = `pokedex-${startStr}-${endStr}`;
  const url = `https://sites.google.com/view/lex3d/${folder}/${num}-${nameSlug}`;

  // Vérifier l'existence
  checkURLExists(url).then(exists => {
    if (exists) {
      window.location.href = url;       // OK → page trouvée
    } else {
      window.location.href = "https://sites.google.com/view/lex3d/accueil";  // ❌ → redirection accueil
    }
  });
}
</script>
